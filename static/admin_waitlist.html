<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Waitlist Admin - LeadBlitz</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: #fafafa;
            min-height: 100vh;
            color: #1f2937;
        }
        .admin-header {
            background: linear-gradient(135deg, #8b5cf6, #a855f7);
            color: #fff;
            padding: 20px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .admin-header h1 { font-size: 1.3rem; font-weight: 700; }
        .admin-header a {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            font-size: 0.85rem;
        }
        .login-container {
            max-width: 400px;
            margin: 80px auto;
            padding: 40px;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        .login-container h2 {
            font-size: 1.3rem;
            margin-bottom: 20px;
            text-align: center;
        }
        .login-container input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            font-size: 0.9rem;
            font-family: inherit;
            margin-bottom: 12px;
        }
        .login-container button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #8b5cf6, #a855f7);
            color: #fff;
            border: none;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
        }
        .login-container button:hover { opacity: 0.9; }
        .login-error {
            color: #ef4444;
            font-size: 0.85rem;
            text-align: center;
            margin-top: 8px;
            display: none;
        }
        .admin-content { padding: 24px; max-width: 1200px; margin: 0 auto; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .stat-card {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            border: 1px solid #f3f4f6;
        }
        .stat-card .stat-value {
            font-size: 1.8rem;
            font-weight: 800;
            color: #8b5cf6;
        }
        .stat-card .stat-label {
            font-size: 0.8rem;
            color: #9ca3af;
            font-weight: 500;
            margin-top: 4px;
        }
        .admin-toolbar {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
            align-items: center;
        }
        .admin-toolbar input {
            flex: 1;
            min-width: 200px;
            padding: 10px 14px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.85rem;
            font-family: inherit;
        }
        .admin-toolbar button, .admin-toolbar a {
            padding: 10px 18px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid #e5e7eb;
            background: #fff;
            color: #374151;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-family: inherit;
        }
        .admin-toolbar button:hover, .admin-toolbar a:hover { background: #f9fafb; }
        .btn-primary {
            background: linear-gradient(135deg, #8b5cf6, #a855f7) !important;
            color: #fff !important;
            border-color: transparent !important;
        }
        .table-wrap {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            border: 1px solid #f3f4f6;
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        th {
            text-align: left;
            padding: 12px 14px;
            background: #f9fafb;
            font-weight: 600;
            color: #6b7280;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            white-space: nowrap;
        }
        th:hover { color: #8b5cf6; }
        td {
            padding: 10px 14px;
            border-bottom: 1px solid #f3f4f6;
            vertical-align: middle;
        }
        tr:hover td { background: #faf5ff; }
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .badge-founding { background: #f5f3ff; color: #7c3aed; }
        .badge-free { background: #f0fdf4; color: #16a34a; }
        .badge-paid { background: #dcfce7; color: #166534; }
        .badge-unpaid { background: #fef3c7; color: #92400e; }
        .badge-invited { background: #dbeafe; color: #1d4ed8; }
        .notes-input {
            width: 120px;
            padding: 4px 8px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 0.8rem;
            font-family: inherit;
        }
        .notes-save {
            padding: 4px 8px;
            font-size: 0.7rem;
            background: #8b5cf6;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
        }
        .invite-checkbox { width: 16px; height: 16px; accent-color: #8b5cf6; }
        .sources-section {
            margin-bottom: 24px;
        }
        .sources-section h3 {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: #6b7280;
        }
        .sources-list {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .source-chip {
            background: #f5f3ff;
            color: #7c3aed;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        #loginSection { display: block; }
        #dashboardSection { display: none; }
        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .admin-toolbar { flex-direction: column; }
            .admin-toolbar input { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="admin-header">
        <h1>LeadBlitz Waitlist Admin</h1>
        <a href="/">Back to site</a>
    </div>

    <div id="loginSection" class="login-container">
        <h2>Admin Login</h2>
        <input type="password" id="adminPassword" placeholder="Admin password" onkeyup="if(event.key==='Enter')adminLogin()">
        <button onclick="adminLogin()">Login</button>
        <p class="login-error" id="loginError">Invalid password</p>
    </div>

    <div id="dashboardSection" class="admin-content">
        <div class="stats-grid" id="statsGrid"></div>
        <div class="sources-section" id="sourcesSection"></div>
        <div class="admin-toolbar">
            <input type="text" id="searchInput" placeholder="Search by email or name..." oninput="debounceSearch()">
            <button onclick="batchInvite()" class="btn-primary">Invite Selected</button>
            <a id="exportLink" href="#" onclick="exportCSV()">Export CSV</a>
        </div>
        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th><input type="checkbox" class="invite-checkbox" onclick="toggleAllCheckboxes(this)"></th>
                        <th onclick="sortTable('signup_number')">#</th>
                        <th onclick="sortTable('email')">Email</th>
                        <th onclick="sortTable('name')">Name</th>
                        <th onclick="sortTable('referral_source')">Source</th>
                        <th onclick="sortTable('tier')">Tier</th>
                        <th>Plan</th>
                        <th>Paid</th>
                        <th>Invited</th>
                        <th onclick="sortTable('created_at')">Date</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody id="waitlistTable"></tbody>
            </table>
        </div>
    </div>

    <script>
        let adminToken = '';
        let currentSort = 'created_at';
        let currentOrder = 'desc';
        let searchTimeout = null;

        async function adminLogin() {
            const pw = document.getElementById('adminPassword').value;
            try {
                const res = await fetch('/api/admin/waitlist/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: pw })
                });
                const data = await res.json();
                if (res.ok && data.success) {
                    adminToken = data.token;
                    document.getElementById('loginSection').style.display = 'none';
                    document.getElementById('dashboardSection').style.display = 'block';
                    loadDashboard();
                } else {
                    document.getElementById('loginError').style.display = 'block';
                }
            } catch (e) {
                document.getElementById('loginError').style.display = 'block';
            }
        }

        function authHeaders() {
            return { 'Authorization': `Bearer ${adminToken}`, 'Content-Type': 'application/json' };
        }

        async function loadDashboard() {
            await Promise.all([loadStats(), loadEntries()]);
        }

        async function loadStats() {
            const res = await fetch('/api/admin/waitlist/stats', { headers: authHeaders() });
            if (!res.ok) return;
            const data = await res.json();
            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card"><div class="stat-value">${data.total_signups}</div><div class="stat-label">Total Signups</div></div>
                <div class="stat-card"><div class="stat-value">${data.founding_members}</div><div class="stat-label">Founding Members</div></div>
                <div class="stat-card"><div class="stat-value">${data.revenue_display}</div><div class="stat-label">Revenue Collected</div></div>
                <div class="stat-card"><div class="stat-value">${data.free_spots_remaining}</div><div class="stat-label">Free Spots Left</div></div>
                <div class="stat-card"><div class="stat-value">${data.signups_today}</div><div class="stat-label">Today</div></div>
                <div class="stat-card"><div class="stat-value">${data.signups_week}</div><div class="stat-label">This Week</div></div>
            `;
            if (data.top_sources && data.top_sources.length > 0) {
                document.getElementById('sourcesSection').innerHTML = `
                    <h3>Top Referral Sources</h3>
                    <div class="sources-list">${data.top_sources.map(s => `<span class="source-chip">${s.source} (${s.count})</span>`).join('')}</div>
                `;
            }
        }

        async function loadEntries() {
            const search = document.getElementById('searchInput').value;
            let url = `/api/admin/waitlist/list?sort_by=${currentSort}&sort_order=${currentOrder}`;
            if (search) url += `&search=${encodeURIComponent(search)}`;

            const res = await fetch(url, { headers: authHeaders() });
            if (!res.ok) return;
            const data = await res.json();

            const tbody = document.getElementById('waitlistTable');
            tbody.innerHTML = data.entries.map(e => `
                <tr>
                    <td><input type="checkbox" class="invite-checkbox entry-checkbox" value="${e.id}" ${e.invited ? 'disabled checked' : ''}></td>
                    <td>${e.signup_number}</td>
                    <td>${e.email}</td>
                    <td>${e.name || '-'}</td>
                    <td>${e.referral_source || '-'}</td>
                    <td><span class="badge ${e.tier === 'founding' ? 'badge-founding' : 'badge-free'}">${e.tier}</span></td>
                    <td>${e.plan || '-'}</td>
                    <td><span class="badge ${e.paid ? 'badge-paid' : 'badge-unpaid'}">${e.paid ? 'Yes' : 'No'}</span></td>
                    <td>${e.invited ? '<span class="badge badge-invited">Invited</span>' : '-'}</td>
                    <td>${e.created_at ? new Date(e.created_at).toLocaleDateString() : '-'}</td>
                    <td>
                        <input class="notes-input" value="${e.notes || ''}" onchange="saveNotes(${e.id}, this.value)" placeholder="Add note...">
                    </td>
                </tr>
            `).join('');
        }

        function sortTable(col) {
            if (currentSort === col) {
                currentOrder = currentOrder === 'desc' ? 'asc' : 'desc';
            } else {
                currentSort = col;
                currentOrder = 'desc';
            }
            loadEntries();
        }

        function debounceSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(loadEntries, 300);
        }

        async function saveNotes(entryId, notes) {
            await fetch('/api/admin/waitlist/notes', {
                method: 'POST',
                headers: authHeaders(),
                body: JSON.stringify({ entry_id: entryId, notes: notes })
            });
        }

        async function batchInvite() {
            const checkboxes = document.querySelectorAll('.entry-checkbox:checked:not(:disabled)');
            const ids = Array.from(checkboxes).map(cb => parseInt(cb.value));
            if (ids.length === 0) return;

            const res = await fetch('/api/admin/waitlist/invite', {
                method: 'POST',
                headers: authHeaders(),
                body: JSON.stringify({ entry_ids: ids })
            });
            const data = await res.json();
            if (data.success) {
                loadDashboard();
            }
        }

        function toggleAllCheckboxes(source) {
            document.querySelectorAll('.entry-checkbox:not(:disabled)').forEach(cb => {
                cb.checked = source.checked;
            });
        }

        async function exportCSV() {
            const res = await fetch('/api/admin/waitlist/export', { headers: authHeaders() });
            if (!res.ok) return;
            const blob = await res.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'waitlist_export.csv';
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
